# 反向代理与负载均衡

## 什么是反向代理
> 在介绍反向代理之前，先看一下什么是正向代理

### 一、正向代理介绍

> **正向代理（forward proxy）**：是一个位于客户端和目标服务器之间的服务器(代理服务器)，为了从目标服务器取得内容，客户端向代理服务器发送一个请求并指定目标，然后代理服务器向目标服务器转交请求并将获得的内容返回给客户端。

这种代理其实在生活中是比较常见的，比如**科学上网**技术，其用到的就是代理技术。

有时候，用户想要访问某国外网站，该网站无法在国内直接访问，但是我们可以访问到一个代理服务器，这个代理服务器可以访问到这个国外网站。这样呢，用户对该国外网站的访问就需要通过代理服务器来转发请求，并且该代理服务器也会将请求的响应再返回给用户。这个上网的过程就是用到了正向代理。

![正向代理](https://blog-figure-bed.oss-cn-shanghai.aliyuncs.com/2020/03/15855829233264.jpg)

这个过程其实和租房子很像。

租房子的时候，一般情况下，我们很难联系到房东，因为有些房东为了图方便，只把自己的房屋信息和钥匙交给中介了。而房客想要租房子，只能通过中介才能联系到房东。而对于房东来说，他可能根本不知道真正要租他的房子的人是谁，他只知道是中介在联系他。这里面一共有三个角色，租客（用户）、中介（代理服务器）和房东（国外网站，目标服务器）。引入中介（代理服务器）的原因是用户无法联系上房东（用户无法访问国外网站）。

**所以，正向代理，其实是"代理服务器"代理了"客户端"，去和"目标服务器"进行交互**。通过正向代理服务器访问目标服务器，目标服务器是不知道真正的客户端是谁的，甚至不知道访问自己的是一个代理（有时候中介也直接冒充租客）。

#### 1.1 正向代理的用途

- **突破访问限制**

    通过代理服务器，可以突破自身IP访问限制，访问国外网站，教育网等。即，租客可以通过中介，来解决无法联系上房东的问题。

- **提高访问速度**

    通常代理服务器都设置一个较大的硬盘缓冲区，会将部分请求的响应保存到缓冲区中，当其他用户再访问相同的信息时，则直接由缓冲区中取出信息，传给用户，以提高访问速度。即，中介手里留存了很多房源信息和钥匙，可以直接带租客去看房。

- **隐藏客户端真实IP**

    上网者也可以通过这种方法隐藏自己的IP，免受攻击。即，房东并不知道租客的真实身份。PS：但是中介知道了，可能骚扰更多….


### 二、反向代理介绍

> **反向代理（reverse proxy）**：是指以代理服务器来接收internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就变现为一个反向代理服务器。

再来看反向代理，继续以租房作类比：

我们在租房子的过程中，除了有些房源需要通过中介以外，还有一些是可以直接通过房东来租的。用户直接找到房东租房的这种情况就是我们不使用代理直接访问国内的网站的情况。

还有一种情况，就是我们以为我们接触的是房东，其实有时候也有可能并非房主本人，有可能是他的亲戚、朋友，甚至是二房东。但是我们并不知道和我们沟通的并不是真正的房东。这种帮助真正的房主租房的二房东其实就是反向代理服务器。这个过程就是**反向代理**。

对于常用的场景，就是我们在Web开发中用到的**负载均衡服务器**（二房东），客户端（租客）发送请求到负载均衡服务器（二房东）上，负载均衡服务器（二房东）再把请求转发给一台真正的服务器（房东）来执行，再把执行结果返回给客户端（租客）。

![反向代理](https://blog-figure-bed.oss-cn-shanghai.aliyuncs.com/2020/03/15855829777765.jpg)


**所以，反向代理，其实是"代理服务器"代理了"目标服务器"，去和"客户端"进行交互**。

通过反向代理服务器访问目标服务器时，客户端是不知道真正的目标服务器是谁的，甚至不知道自己访问的是一个代理。

#### 2.1 反向代理的用途

- **隐藏服务器真实IP**

    使用反向代理，可以对客户端隐藏服务器的IP地址。
    即，租客并不房东知道的真实身份。

- **负载均衡**

    反向代理服务器可以做**负载均衡**，根据所有真实服务器的负载情况，将客户端请求分发到不同的真实服务器上。
    即，二房东发现房主本人很忙，于是找到房主的妻子帮忙处理租房事宜。

- **提高访问速度**

    反向代理服务器可以对于静态内容及短时间内有大量访问请求的动态内容提供缓存服务，提高访问速度。
    即，二房东同样有房屋信息和钥匙。
    
- **提供安全保障**

    反向代理服务器可以作为应用层防火墙，为网站提供对基于Web的攻击行为（例如DoS/DDoS）的防护，更容易排查恶意软件等。还可以为后端服务器统一提供加密和SSL加速（如SSL终端代理），提供HTTP访问认证等。
    即，二房东可以有效的保护房东的安全。
    

### 三、正向代理和反向代理的区别

虽然**正向代理服务器**和**反向代理服务器**所处的位置都是客户端和真实服务器之间，所做的事情也都是把客户端的请求转发给服务器，再把服务器的响应转发给客户端，但是二者之间还是有一定的差异的。

- **正向代理其实是客户端的代理**，帮助客户端访问其无法访问的服务器资源。**反向代理则是服务器的代理**，帮助服务器做负载均衡，安全防护等。
- **正向代理一般是客户端架设的**，比如在自己的机器上安装一个代理软件。而**反向代理一般是服务器架设的**，比如在自己的机器集群中部署一个反向代理服务器。
- **正向代理中，服务器不知道真正的客户端到底是谁**，以为访问自己的就是真实的客户端。而在**反向代理中，客户端不知道真正的服务器是谁**，以为自己访问的就是真实的客户端。
- 正向代理和反向代理的作用和目的不同。**正向代理主要是用来解决访问限制问题**。而**反向代理则是提供负载均衡、安全防护等作用。二者均能提高访问速度**。

## 什么是负载均衡

为了提升网站的各方面能力，我们一般会把多台机器组成一个集群对外提供服务。然而，我们的网站对外提供的访问入口都是一个的，比如`www.taobao.com`。那么当用户在浏览器输入`www.taobao.com`的时候如何将用户的请求分发到集群中不同的机器上呢，这就是负载均衡在做的事情。

![什么是负载均衡](https://blog-figure-bed.oss-cn-shanghai.aliyuncs.com/2020/03/15855830980467.jpg)

**负载均衡（Load Balance），意思是将负载（工作任务，访问请求）进行平衡、分摊到多个操作单元（服务器，组件）上进行执行。是解决高性能，单点故障（高可用），扩展性（水平伸缩）的终极解决方案。**

### OSI 网络模型

想要实现负载均衡，其实有很多种做法，在深入介绍负载均衡之前，要先介绍一个概念，那就是**OSI七层模型**。

网络模型就是 `OSI（Open System Interconnect）`，意思为`开放网络互联`，是由国际标准化组织(ISO)和国际电报电话咨询委员会(CCITT)共同出版的，它是一种网络互联模型，也是一种规范。

![OSI模型](https://blog-figure-bed.oss-cn-shanghai.aliyuncs.com/2020/03/15855831579414.jpg)

网络模型分为七层，也就是当用户发起请求到服务器接收，会历经七道工序，或者说用户利用互联网发送消息给另一个用户，也会历经七道工序。这七层可以分为如下：

| 层级   | 名称       | 说明                                     |
| :----- | :--------- | :--------------------------------------- |
| 第七层 | 应用层     | 与用户行为交互                           |
| 第六层 | 表示层     | 定义数据格式以及数据加密                 |
| 第五层 | 会话层     | 创建、管理以及销毁会话                   |
| 第四层 | 传输层     | 创建、管理请求端到响应端（端到端）的连接 |
| 第三层 | 网络层     | 请求端的IP地址                           |
| 第二层 | 数据链路层 | 提供介质访问与链路管理                   |
| 第一层 | 物理层     | 传输介质，物理媒介                       |

以上七层每层可以与上下相邻层进行通信。每一层都是非常复杂的，我们不在这里深究，我们以举例的形式来阐述每一层是干嘛的。

- **应用层：** 这是面向用户的，最靠近用户，为了让用户和计算机交互，在计算机里会有很多软件，比如eclipse，idea，qq，nginx等，这些都是应用软件，用户可以通过这些应用软件和计算机交互，交互的过程其实就是接口的调用，应用层为用户提供了交互的接口，以此为用户提供交互服务。那么在这一层最常见的协议有：HTTP,HTTPS,FTP,SMTP,POP3等。Nginx在本层，为七层负载均衡。
  举例：我要寄一封信给远在天边的老外LiLei，我会打开快递软件下单，这个时候我是`用户`，快递软件就是`应用服务`，是建立在计算机上的，提供给用户交互的一种服务或称之为手段。
- **表示层：** 该层提供数据格式编码以及加密功能，确保`请求端`的数据能被`响应端`的应用层识别。
  举例：我写中文给LiLei，他看不懂，这个时候我就会使用翻译软件把中文翻译成英文，随后信中涉及到一些比较隐私的信息我会加密一下，这个时候翻译软件和加密器就充当了`表示层`的作用，他用于显示用户能够识别的内容。
- **会话层：** 会话可以理解为session，请求发送到接受响应的这个过程之间存在会话，会话层就充当了这一过程的管理者，从创建会话到维护会话最后销毁会话。
  举例：我每次写信给LiLei都会记录在一个小本本上，寄信时间日期，收信时间日期，这本小本本上存有每次通信记录，这个小本本就相当于是一个会话的管理者。又或者说，我们平时在打电话，首先需要拨打电话，这是`建立会话`，对方接听电话，此时正在通话（`维持并管理会话`），通话结束后`会话销毁`，那么这也是一次会话的生命周期。
- **传输层：** 该层建立端到端的连接，他提供了数据传输服务，在传输层通信会涉及到端口号，本层常见的协议为TCP、UDP，LVS就是在传输层，也就是四层负载均衡。
  举例：我和LiLei通信过程中会借助快递公司，快递公司会分配快递员取件和寄件，那么这个快递员则充当`传输层`的作用。
- **网络层：** 网络通信的时候必须要有本机IP和对方的IP，请求端和响应端都会有自己的IP的，IP就相当于你家地址门牌号，在网络上云服务器有固定的公网IP，普通计算机也有，只不过是动态IP，运营商每天会分配不同的IP给你的计算机。所以网络层也能称之为IP层，IP是互联网的基础根本。能提供IP分配的设备则为路由器或交换机。
  举例：对于拥有固定IP的云服务来说，他们都是由腾讯云、阿里云等这样的供应商提供的，他们为云服务器提供固定ip；电信、移动、联调等运营商为你的计算机动态分配ip，每天都不同；则这些供应商和运营商都是网络层。同理，快递员由物流公司分配和管理，那么物流公司就是`网络层`咯。
- **数据链路层：** 这一层会提供计算机MAC地址，通信的时候会携带，为了确保请求投递正确，所以他会验证检测MAC地址，以确保请求响应的可靠性。
  举例：快递员在投递派送的时候，他（或客服）会预先提前打电话给你，确认你家地址对不对、有没有人、货到付款有没有准备好钱等等，这个时候快递员（或客服）就充当了`数据链路层`的职责。
- **物理层：** 端到端请求响应过程中的媒介，物理介质，比如网线、中继器等等设备，都是你在端到端交互过程中不可缺少的基础设备。
  举例：快递员在投递的过程中，你写的信会历经一些交通运输工具，比如首先通过飞机运输到国外，在海关统一拿到信以后会通过汽车运输到LiLei所在城市的物流集散地，最后快递员通过三轮电频车寄到LiLei家里，这个时候，飞机、汽车、三轮电瓶车都是`物理层`的媒介。

 以上就是七层网络模型，大家理解其意义即可。需要注意的是**Nginx**存在于第七层，属于**七层负载均衡**；而第四层会有**LVS**，属于**四层负载均衡**。

### 负载均衡分类

我们经常听到的一些和计算机网络有关的概念中：

> telnet、HTTP、FTP、NFS、SMTP、DNS等属于第七层应用层的概念。
>
> TCP、UDP、SPX等属于第四层传输层的概念。
>
> IP、IPX等属于第三层网络层的概念。
>
> ATM、FDDI等属于第二层数据链路层的概念。

了解了网络协议的七层模型以后，再来看看负载均衡。我们可以很明确的一点是，**负载均衡是要在网络传输中做文章的**。而要在网络传输过程搞事情，那么这七层模型就势必躲不开。

所以，根据负载均衡技术实现在OSI七层模型的不同层次，是可以给负载均衡分类的。

常见的实现方式中，主要可以在应用层、传输层、网络层和数据传输层做文章。所以，工作在应用层的负载均衡，我们通常称之为七层负载均衡、工作在传输层的我们称之为四层负载均衡。

大致可以分为以下几种，其中最常用的是四层和七层负载均衡：

1. **二层负载均衡**

    负载均衡服务器对外依然提供一个VIP（虚IP），集群中不同的机器采用相同IP地址，但是机器的MAC地址不一样。当负载均衡服务器接受到请求之后，通过改写报文的目标MAC地址的方式将请求转发到目标机器实现负载均衡。

2. **三层负载均衡**

    和二层负载均衡类似，负载均衡服务器对外依然提供一个VIP（虚IP），但是集群中不同的机器采用不同的IP地址。当负载均衡服务器接受到请求之后，根据不同的负载均衡算法，通过IP将请求转发至不同的真实服务器。

3. **四层负载均衡** 

    四层负载均衡工作在OSI模型的传输层，由于在传输层，只有TCP/UDP协议，这两种协议中除了包含源IP、目标IP以外，还包含源端口号及目的端口号。四层负载均衡服务器在接受到客户端请求后，以后通过修改数据包的地址信息（IP+端口号）将流量转发到应用服务器。

4. **七层负载均衡** 

    七层负载均衡工作在OSI模型的应用层，应用层协议较多，常用http、radius、dns等。七层负载就可以基于这些协议来负载。这些应用层协议中会包含很多有意义的内容。比如同一个Web服务器的负载均衡，除了根据IP加端口进行负载外，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。